<!-- src/pages/Wheel.vue -->
<script setup>
import { ref, onMounted, onUnmounted, computed } from 'vue'
import BottomNav from '../components/BottomNav.vue'
import { LuckyWheel } from '@lucky-canvas/vue'

/* ====== STATE ====== */
const wheelRef = ref(null)

const state = ref({
  cooldown: 1200,   // 20 ph√∫t m·∫∑c ƒë·ªãnh (server c√≥ th·ªÉ tr·∫£ kh√°c)
  remaining: 0,     // gi√¢y c√≤n l·∫°i ƒë·ªÉ xem ad/quay
  htw_balance: 0,   // s·ªë d∆∞
  today: 0,         // h√¥m nay ƒë√£ quay
  limit: 30,        // gi·ªõi h·∫°n/ng√†y
})
const busy = ref(false)
const loading = ref(true)
const msg = ref('')
const spinning = ref(false)
const claimInProgress = ref(false)
const pendingToast = ref('') // s·∫Ω hi·ªÉn th·ªã khi v√≤ng quay d·ª´ng

let timerId = null

/* ====== ADSGRAM REWARD ====== */
const REWARD_SDK_URL = 'https://sad.adsgram.ai/js/sad.min.js'
const rewardBlockId = String(import.meta.env.VITE_ADSGRAM_WHEEL_REWARD_BLOCK_ID || '')
const loadingRewardSdk = ref(false)

function loadRewardSdk () {
  if ([...document.scripts].some(s => s.src === REWARD_SDK_URL)) return Promise.resolve()
  loadingRewardSdk.value = true
  return new Promise((resolve, reject) => {
    const s = document.createElement('script')
    s.src = REWARD_SDK_URL
    s.async = true
    s.onload = () => { loadingRewardSdk.value = false; resolve() }
    s.onerror = (e) => { loadingRewardSdk.value = false; reject(e) }
    document.head.appendChild(s)
  })
}

// lu√¥n bu·ªôc xem Reward tr∆∞·ªõc khi quay
async function showRewardAd () {
  if (!rewardBlockId) throw new Error('Thi·∫øu VITE_ADSGRAM_WHEEL_REWARD_BLOCK_ID')
  await loadRewardSdk()
  const ctrl = window.Adsgram?.init?.({ blockId: String(rewardBlockId) })
  if (!ctrl) throw new Error('Kh√¥ng kh·ªüi t·∫°o ƒë∆∞·ª£c Adsgram Reward')
  await ctrl.show() // resolve khi ng∆∞·ªùi d√πng ƒë√£ xem xong
}

/* ====== WHEEL UI (4 √¥: +2, +3, +4, +5) ====== */
const blocks = [{ padding: '12px', background: '#0f172a' }]
const prizes = [
  { background: '#0ea5e9', fonts: [{ text: '+2 HTW', top: '18px' }] },
  { background: '#f59e0b', fonts: [{ text: '+3 HTW', top: '18px' }] },
  { background: '#10b981', fonts: [{ text: '+4 HTW', top: '18px' }] },
  { background: '#8b5cf6', fonts: [{ text: '+5 HTW', top: '18px' }] },
]
const buttons = [
  { radius: '40px', background: '#2563eb', pointer: true, fonts: [{ text: 'SPIN', top: '-18px' }] }
]

/* ====== API ====== */
async function loadStatus () {
  loading.value = true
  msg.value = ''
  try {
    const r = await fetch('/api/wheel', { credentials: 'include' })
    if (!r.ok) throw new Error(await r.text())
    const data = await r.json()
    state.value.cooldown    = Number(data.cooldown ?? state.value.cooldown)
    state.value.remaining   = Number(data.remaining ?? 0)
    state.value.htw_balance = Number(data.htw_balance ?? 0)
    state.value.today       = Number(data.today ?? 0)
    state.value.limit       = Number(data.daily_limit ?? state.value.limit)
    if (state.value.remaining > 0) startTicker()
  } catch (e) {
    console.error(e)
    msg.value = 'Kh√¥ng t·∫£i ƒë∆∞·ª£c tr·∫°ng th√°i v√≤ng quay.'
  } finally {
    loading.value = false
  }
}

/* ====== AUTO-SPIN SAU KHI XEM AD ====== */
const MIN_SPIN_MS = 1000

async function spin () {
  if (!canSpin.value || claimInProgress.value) return
  claimInProgress.value = true
  busy.value = true
  msg.value = ''
  pendingToast.value = ''

  try {
    // 1) Bu·ªôc xem qu·∫£ng c√°o tr∆∞·ªõc
    await showRewardAd()

    // 2) B·∫Øt ƒë·∫ßu quay ngay ƒë·ªÉ m∆∞·ª£t
    spinning.value = true
    wheelRef.value?.play?.()

    // 3) Server quy·∫øt ƒë·ªãnh k·∫øt qu·∫£ + c·ªông HTW
    const [_, server] = await Promise.all([
      new Promise(res => setTimeout(res, MIN_SPIN_MS)), // ƒë·∫£m b·∫£o quay t·ªëi thi·ªÉu
      fetch('/api/wheel', { method: 'POST', credentials: 'include' })
        .then(async r => ({ ok: r.ok, data: await r.json().catch(()=>({})) }))
        .catch(() => ({ ok: false, data: null }))
    ])

    if (!server?.ok || server.data?.ok !== true) {
      // th·∫•t b·∫°i/cooldown/daily-limit: d·ª´ng quay v√† hi·ªÉn th·ªã th√¥ng b√°o
      wheelRef.value?.stop?.(0)
      const remain = Number(server?.data?.remaining ?? state.value.cooldown)
      state.value.remaining = remain
      state.value.today = Number(server?.data?.today_count ?? state.value.today)
      startTicker()
      msg.value = server?.data?.ok === false
        ? (state.value.today >= state.value.limit ? 'H√¥m nay ƒë√£ ƒë·ªß s·ªë l·∫ßn.' : 'Ch∆∞a h·∫øt th·ªùi gian ch·ªù.')
        : 'Quay th·∫•t b·∫°i.'
      return
    }

    // an to√†n & kh√¥ng l√†m l·ªách index (4 √¥: 0..3)
    const idxRaw = Number(server.data.index)
    const idx = (Number.isFinite(idxRaw) && idxRaw >= 0 && idxRaw < prizes.length) ? idxRaw : 0
    wheelRef.value?.stop?.(idx)

    // c·∫≠p nh·∫≠t s·ªë d∆∞ + cooldown + today
    state.value.htw_balance = Number(server.data.htw_balance ?? state.value.htw_balance)
    state.value.remaining   = Number(server.data.remaining ?? state.value.cooldown)
    state.value.today       = Math.min(state.value.today + 1, state.value.limit)
    startTicker()

    // chu·∫©n b·ªã th√¥ng ƒëi·ªáp khi v√≤ng quay d·ª´ng (@end)
    const add = Number(server.data.add ?? 0)
    pendingToast.value = `+${add} HTW üéâ`
  } catch (e) {
    console.error(e)
    spinning.value = false
    msg.value = e?.message || 'Quay th·∫•t b·∫°i, th·ª≠ l·∫°i sau.'
  } finally {
    busy.value = false
    setTimeout(() => { claimInProgress.value = false }, 1200)
  }
}

/* ====== x·ª≠ l√Ω khi v√≤ng quay d·ª´ng ====== */
function onEnd () {
  spinning.value = false
  if (pendingToast.value) {
    toast(pendingToast.value)
    try {
      window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success')
    } catch {}
    pendingToast.value = ''
  }
}

/* ====== countdown ====== */
function startTicker () {
  stopTicker()
  timerId = setInterval(() => {
    if (state.value.remaining > 0) state.value.remaining--
    else stopTicker()
  }, 1000)
}
function stopTicker () { if (timerId) { clearInterval(timerId); timerId = null } }

const canSpin = computed(() =>
  !busy.value &&
  !spinning.value &&
  !claimInProgress.value &&
  state.value.remaining <= 0 &&
  !loading.value &&
  state.value.today < state.value.limit
)

function fmtTime (sec) {
  const m = String(Math.floor(sec / 60)).padStart(2, '0')
  const s = String(Math.floor(sec % 60)).padStart(2, '0')
  return `${m}:${s}`
}

/* ====== toast ====== */
function toast (t) {
  const el = document.createElement('div')
  el.className = 'toast'
  el.textContent = t
  document.body.appendChild(el)
  requestAnimationFrame(() => el.classList.add('show'))
  setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 250) }, 1600)
}

/* ====== LIFECYCLE ====== */
onMounted(loadStatus)
onUnmounted(stopTicker)
</script>

<template>
  <div class="page">
    <header class="topbar"><h1>V√≤ng quay may m·∫Øn</h1></header>

    <main class="wrap">
      <!-- S·ªë d∆∞ -->
      <section class="card hero">
        <div class="hero-ic"><i class="bi bi-bullseye"></i></div>
        <div class="hero-t">
          <div class="label">S·ªë d∆∞ HTW</div>
          <div class="amount">{{ state.htw_balance.toLocaleString() }} <span>HTW</span></div>
        </div>
      </section>

      <section class="card wheel">
        <LuckyWheel
          ref="wheelRef"
          :width="320"
          :height="320"
          :blocks="blocks"
          :prizes="prizes"
          :buttons="buttons"
          @end="onEnd"
        />

        <div class="cooldown">
          <template v-if="state.remaining > 0">
            <i class="bi bi-hourglass-split"></i>
            C√≤n l·∫°i: <b>{{ fmtTime(state.remaining) }}</b>
            <span class="mut"> ‚Ä¢ H√¥m nay: {{ state.today }}/{{ state.limit }}</span>
          </template>
          <template v-else>
            <span class="mut">H√¥m nay: {{ state.today }}/{{ state.limit }}</span>
          </template>
        </div>

        <button
          class="btn"
          :disabled="!canSpin || loading || loadingRewardSdk"
          @click="spin"
        >
          <i v-if="busy || loading || loadingRewardSdk" class="bi bi-arrow-repeat spin"></i>
          <i v-else class="bi bi-play-circle"></i>
          <span>
            {{ state.today>=state.limit ? 'ƒê√£ ƒë·∫°t ' + state.limit + ' l·∫ßn' : (state.remaining > 0 ? 'Ch∆∞a th·ªÉ quay' : 'Quay ngay') }}
          </span>
        </button>

        <p v-if="!rewardBlockId" class="note warn">
          ‚ö†Ô∏è Thi·∫øu <b>VITE_ADSGRAM_WHEEL_REWARD_BLOCK_ID</b> n√™n kh√¥ng th·ªÉ hi·ªÉn th·ªã qu·∫£ng c√°o Reward.
        </p>
        <p v-if="msg" class="note">{{ msg }}</p>
      </section>

      <section v-if="loading" class="card center">
        <i class="bi bi-hourglass-split big spin"></i>
        <div>ƒêang t·∫£i‚Ä¶</div>
      </section>
    </main>

    <BottomNav />
  </div>
</template>

<style scoped>
/* (gi·ªØ nguy√™n ph·∫ßn style c·ªßa b·∫°n) */
</style>
